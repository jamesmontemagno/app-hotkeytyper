name: Build Self-Contained Windows App

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build-win-selfcontained:
    runs-on: windows-latest
    strategy:
      fail-fast: false
      matrix:
        rid: [win-x64, win-arm64]
    env:
      PROJECT_PATH: HotkeyTyper/HotkeyTyper.csproj
      RUNTIME_ID: ${{ matrix.rid }}
      CONFIGURATION: Release
      VERSION: 0.0.${{ github.run_number }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '10.0.x'

      - name: Cache NuGet packages
        uses: actions/cache@v4
        with:
            path: ~/.nuget/packages
            key: ${{ runner.os }}-nuget-${{ hashFiles('**/packages.lock.json', '**/*.csproj') }}
            restore-keys: |
              ${{ runner.os }}-nuget-

      - name: Restore
        run: dotnet restore $env:PROJECT_PATH

      - name: Publish self-contained (${{ matrix.rid }})
        run: >-
          dotnet publish $env:PROJECT_PATH
          -c $env:CONFIGURATION
          -r $env:RUNTIME_ID
          --self-contained true
          /p:PublishSingleFile=true
          /p:IncludeNativeLibrariesForSelfExtract=true
          /p:EnableCompressionInSingleFile=true
          /p:PublishReadyToRun=true
          /p:ReadyToRunShowWarnings=true
          /p:DebugType=None
          /p:DebugSymbols=false
          /p:Version=$env:VERSION
          /p:FileVersion=$env:VERSION
          /p:AssemblyVersion=$env:VERSION
          /p:InformationalVersion=$env:VERSION
          -o publish/$env:RUNTIME_ID

      - name: Copy license and readme
        run: |
          Copy-Item README.md publish/$env:RUNTIME_ID -ErrorAction SilentlyContinue
          Copy-Item LICENSE publish/$env:RUNTIME_ID -ErrorAction SilentlyContinue

      - name: Rename executable for Updatum (${{ matrix.rid }})
        id: rename_exe
        run: |
          $exeName = "HotkeyTyper_${{ env.RUNTIME_ID }}_v${{ env.VERSION }}.exe"
          Copy-Item "publish/$env:RUNTIME_ID/HotkeyTyper.exe" $exeName
          echo "exe_name=$exeName" >> $env:GITHUB_OUTPUT

      - name: Create zip artifact (${{ matrix.rid }})
        id: zip
        run: |
          $zipName = "HotkeyTyper_${{ env.RUNTIME_ID }}_${{ env.VERSION }}.zip"
          Compress-Archive -Path publish/$env:RUNTIME_ID/* -DestinationPath $zipName
          echo "zip_name=$zipName" >> $env:GITHUB_OUTPUT

      - name: Upload zip artifact (${{ matrix.rid }})
        uses: actions/upload-artifact@v4
        with:
          name: HotkeyTyper-${{ env.VERSION }}-${{ env.RUNTIME_ID }}-zip
          path: ${{ steps.zip.outputs.zip_name }}
          if-no-files-found: error

      - name: Upload exe artifact (${{ matrix.rid }})
        uses: actions/upload-artifact@v4
        with:
          name: HotkeyTyper-${{ env.VERSION }}-${{ env.RUNTIME_ID }}-exe
          path: ${{ steps.rename_exe.outputs.exe_name }}
          if-no-files-found: error

      - name: Summary append (${{ matrix.rid }})
        run: |
          echo "Built version $env:VERSION for $env:RUNTIME_ID (ReadyToRun enabled)." >> $GITHUB_STEP_SUMMARY
          echo "Artifact: HotkeyTyper-${{ env.VERSION }}-${{ env.RUNTIME_ID }}" >> $GITHUB_STEP_SUMMARY

  release:
    needs: build-win-selfcontained
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && github.run_attempt == 1
    permissions:
      contents: write
    env:
      VERSION: 0.0.${{ github.run_number }}
      TAG: v0.0.${{ github.run_number }}
    steps:
      - name: Checkout (for context)
        uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: List downloaded artifacts
        run: |
          echo "Artifacts downloaded:" 
          ls -R artifacts

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ env.TAG }}
          name: HotkeyTyper ${{ env.VERSION }}
          draft: false
          prerelease: false
          generate_release_notes: true
          files: |
            artifacts/**/*.zip
            artifacts/**/*.exe
          body: |
            ## TL;DR
            
            A lightweight Windows utility that types predefined text into any application using a customizable global hotkey (default: CTRL+SHIFT+1). Perfect for demos, tutorials, and presentations.
            
            **Download:** Choose `win-x64` for Intel/AMD (most common) or `win-arm64` for ARM devices. Both `.zip` and standalone `.exe` versions available.
            
            **Quick Start:** Extract/run â†’ Configure text â†’ Set hotkey â†’ Press hotkey in any app to type!
            
            ---
            
            ### ðŸ“¦ Download & Installation
            
            - **`HotkeyTyper_win-x64_*.zip`** or **`.exe`** - For 64-bit Intel/AMD processors (most common)
            - **`HotkeyTyper_win-arm64_*.zip`** or **`.exe`** - For ARM64 devices (Surface Pro X, etc.)
            
            **System Requirements:** Windows 10 or later (self-contained, no additional runtime needed)
            
            ---
            
            ### ðŸ“š Resources
            
            - [Full Documentation](https://github.com/jamesmontemagno/app-hotkeytyper/blob/main/README.md)
            - [Keyboard Configuration Guide](https://github.com/jamesmontemagno/app-hotkeytyper/blob/main/README.md#configuring-the-hotkey)
            - [Typing Source Code & Special Characters](https://github.com/jamesmontemagno/app-hotkeytyper/blob/main/README.md#typing-source-code--special-characters)
            
            **Build Info:** Version ${{ env.VERSION }} | Build ${{ github.run_number }} | Runtimes: win-x64, win-arm64
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Append release summary
        run: |
          echo "Release created: ${{ env.TAG }}" >> $GITHUB_STEP_SUMMARY
